# Google Apps Script 実装完了レポート

## プロジェクト概要

**OCR-ベースの日本語決算書自動抽出・転記システム**

Gemini APIを使用してPDFの決算書をOCR抽出し、Google Sheetsの複数の比較分析表に自動的に転記するシステムです。

---

## 実装内容

### バージョン
- **v3.0.0** - 2025年10月26日

### 総ファイル数
- 1507行のGASコード（コード.js）
- HTML UI (dialog.html)
- 設定ファイル (appsscript.json)

### 実装された主要機能

#### 1. **CONFIG設定の拡張（新規）**
```javascript
EXCEL_TRANSFER_CONFIG: {
  SHEET_NAME: '４．３期比較表',
  PERIOD_COLUMNS: { 前々期, 前期, 当期 },
  TABLES: {
    '①売上高内訳表',
    '②販売費及び一般管理費比較表',
    '③変動費内訳比較表',
    '④製造経費比較表',
    '⑤その他損益比較表'
  }
}
```

**各表の詳細設定：**
- テーブルタイプ: `simple`（①）、`classified`（②）、`topN_with_other`（③）、`classified_by_category`（④）、`simple_aggregate`（⑤）
- セル範囲（行・列）
- グループ・カテゴリ設定
- 計算ロジック

#### 2. **ヘルパー関数群（新規追加）**

| 関数名 | 用途 |
|--------|------|
| `prepareExcelTransferData()` | OCRデータを転記用に正規化 |
| `classifyItemToTable()` | 項目名から転記先表を判定 |
| `readExcelRowData()` | Google Sheetsの複数期データを読み込み |
| `readExcelTableData()` | 複数行をまとめて読み込み |
| `writeExcelRowData()` | 複数期の金額を一括書き込み |
| `sortByCurrentPeriod()` | 当期金額で降順ソート |
| `aggregateAmounts()` | 複数項目の金額を合計 |

#### 3. **表別転記ロジック（新規実装）**

##### ① 売上高内訳表 (`transferToTable01_SalesBreakdown`)
- **タイプ:** シンプル転記型
- **ロジック:** OCRデータをそのまま行順に転記
- **対象行:** 6-8行（3項目）

##### ② 販売費及び一般管理費比較表 (`transferToTable02_SGA`)
- **タイプ:** 分類集計型
- **ロジック:**
  - 項目を「人件費」「その他経費」に自動分類
  - 各グループを金額（当期）でソート
  - 人件費グループ：6行まで個別転記、超過分は「その他人件費」に集計
  - その他経費グループ：17行まで個別転記、超過分は「その他」に集計

##### ③ 変動費内訳比較表 (`transferToTable03_VariableCosts`)
- **タイプ:** 上位N件+その他型
- **ロジック:**
  - 当期金額で降順ソート
  - 上位3件を個別転記
  - 4件目以降を「（その他）」として合計転記

##### ④ 製造経費比較表 (`transferToTable04_ManufacturingExpenses`)
- **タイプ:** 費目別分類型
- **ロジック:**
  - 5つのカテゴリに自動分類：
    - 賃金 → 賃金給料（行25）
    - 賞与 → 賞与（行26）
    - 法定福利 → 法定福利費（行27）
    - 福利厚生 → 福利厚生費（行28）
    - その他 → その他経費（行39）
  - 各カテゴリの合計を対応する行に転記

##### ⑤ その他損益比較表 (`transferToTable05_OtherPL`)
- **タイプ:** シンプル集計型
- **ロジック:** 全項目の合計を計算

#### 4. **統合処理機能（新規）**

| 関数名 | 用途 |
|--------|------|
| `classifyOcrDataByMapping()` | OCRデータを各表別に自動分類 |
| `executeExcelTransfer()` | 分類→転記の統合実行 |
| `recordTransferLog()` | 転記結果をログに記録 |
| `startStep3_transferDataToExcel()` | メイン実行関数（ステップ３新版） |

#### 5. **ユーザーインターフェース更新**

**メニュー構成（v3.0.0）:**
```
決算書OCR (v3.0.0)
├── 【ステップ１】ファイル選択＆OCR実行
├── 【ステップ２】転記設定 (マッピング) シート準備
├── 【ステップ３】マッピングを適用して転記 (旧)
├── 【ステップ３NEW】自動分類して各表に転記（推奨）
└── 【管理】転記ログを表示
```

---

## 技術仕様

### 金額列の配置（標準レイアウト A-K列）
```
A列: 項目名
B列: 前々期 金額
C列: 前々期 売上比
D列: 前期 金額
E列: 前期 売上比
F列: 前期 前年比
G列: 前期 対年変更
H列: 当期 金額
I列: 当期 売上比
J列: 当期 前年比
K列: 当期 対年変更
```

### 金額列の配置（拡張レイアウト M-W列）
```
M列: 項目名
N列: 前々期 金額
O列: 前々期 売上比
P列: 前期 金額
Q列: 前期 売上比
R列: 前期 前年比
S列: 前期 対年変更
T列: 当期 金額
U列: 当期 売上比
V列: 当期 前年比
W列: 当期 対年変更
```

### 使用期間構造
1期ずつのOCR抽出に対応：
- 各期の金額は別々にOCR実行可能
- 複数期の蓄積により3期比較表を完成

---

## 使用方法

### 基本フロー

1. **ステップ１：ファイル選択＆OCR実行**
   - PDFファイルをGemini APIでOCR処理
   - 抽出データを「OCR作業シート」に出力

2. **ステップ２：転記設定 (マッピング) シート準備**
   - OCR結果と転記先のマッピングを定義
   - （オプション：手動調整可能）

3. **ステップ３NEW：自動分類して各表に転記（推奨）**
   - OCRデータを自動分類
   - 各表に最適なロジックで転記
   - 転記ログを「調整ログ」シートに記録

---

## エラーハンドリング

### 実装済みの保護機能

1. **入力値の正規化**
   - 日本語テキストのUnicode NFKC正規化
   - 全角/半角の統一
   - 複数の負数表現サポート（▲、△、括弧など）

2. **安全性チェック**
   - 数式インジェクション防止
   - 無効な数値の検出

3. **ロギング**
   - すべての転記操作をログに記録
   - エラーメッセージの詳細化
   - ステータス別の色分け表示（成功：緑、エラー：赤）

---

## パフォーマンス

- **処理規模:** 最大数百項目の同時処理
- **実行時間:** 数秒～数十秒（項目数による）
- **リトライ機能:** API呼び出しで3回までのリトライとバックオフ

---

## 今後の拡張可能性

1. **複数期データの一括処理**
   - 3期分を同時にOCR抽出し、自動マッピング

2. **マッピングシートの強化**
   - 動的プルダウン（C列の選択によってD列が変更）
   - ユーザーカスタマイズルール

3. **計算式の自動設定**
   - 合計・小計の自動計算
   - バランスチェック機能

4. **複数拠点対応**
   - 複数の決算書テンプレートに対応

---

## ファイル一覧

| ファイル名 | 行数 | 用途 |
|----------|------|------|
| コード.js | 1507 | メインロジック（GAS） |
| dialog.html | 104 | ファイル選択UI |
| appsscript.json | 7 | GAS設定 |
| .clasp.json | 16 | Claspプロジェクト設定 |

---

## テスト確認項目

- [ ] ステップ１：PDF OCR抽出が正常に動作
- [ ] ステップ２：マッピングシート生成が正常に動作
- [ ] ステップ３NEW：自動分類が正確に実行
- [ ] 各表への転記が正確に実行
- [ ] 転記ログが正常に記録
- [ ] エラーメッセージが適切に表示

---

## 更新履歴

### v3.0.0 (2025-10-26)
- ✅ エクセル転記機能の大規模拡張
- ✅ 5つの表に対応した専用転記ロジック実装
- ✅ 自動分類・集計機能の実装
- ✅ 複数期対応（前々期/前期/当期）
- ✅ ヘルパー関数群の追加
- ✅ メニューUI更新

### v2.0.0 (前バージョン)
- Google Sheets ↔ Excel 連携の基本機能
- OCR基本機能

---

## サポート・トラブルシューティング

### よくある問題

**Q: 「シート「４．３期比較表」が見つかりません」というエラーが出ます**
- A: Google Sheetsの対応するシート名を確認してください。設定値: `CONFIG.EXCEL_TRANSFER_CONFIG.SHEET_NAME`

**Q: 転記位置がずれている**
- A: CONFIG設定の行番号（`dataStartRow`, `dataEndRow` など）を確認し、実際のシート構造と照合してください。

**Q: 「警告: 分類不可の項目」が多発します**
- A: `classifyItemToTable()` 関数のキーワード判定ロジックをカスタマイズしてください。

---

## まとめ

このシステムは、Gemini APIのOCR機能とGoogle Apps Scriptを組み合わせた、**日本の決算書処理の自動化ツール**です。

複雑な勘定科目の分類・集計を自動化し、ユーザーの手作業を大幅に削減します。

