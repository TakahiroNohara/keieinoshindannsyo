<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: sans-serif; padding: 10px; color: #333; }
      h3 { margin-top: 0; }
      select, button { width: 100%; padding: 8px; margin-top: 10px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; }
      label { margin-top: 15px; display: block; font-size: 0.9em; }
      button { background-color: #4285F4; color: white; border: none; cursor: pointer; font-weight: bold; }
      button:hover { background-color: #357AE8; }
      button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
      #loader { display: none; margin-top: 10px; text-align: center; color: #555; }
    </style>
  </head>
  <body>
    <h3>決算書ファイルを選択</h3>
    
    <label for="folder-select">1. フォルダを選択してください:</label>
    <select id="folder-select" onchange="loadFiles()">
      <option value="">読み込み中...</option>
    </select>
    
    <div id="loader">ファイルを検索中...</div>

    <label for="file-select">2. PDFファイルを選択してください:</label>
    <select id="file-select" disabled>
      <option value="">フォルダを先に選択</option>
    </select>
    
    <button onclick="selectFile()" id="select-button" disabled>このファイルで抽出を開始</button>

    <script>
      window.onload = function() {
        google.script.run.withSuccessHandler(populateFolders).getFolders();
      };

      function populateFolders(folders) {
        const select = document.getElementById('folder-select');
        select.innerHTML = '<option value="">選択してください</option>';
        folders.forEach(function(folder) {
          let option = new Option(folder.name, folder.id);
          select.appendChild(option);
        });
      }
      
      function loadFiles() {
        const folderSelect = document.getElementById('folder-select');
        const fileSelect = document.getElementById('file-select');
        const loader = document.getElementById('loader');
        const selectButton = document.getElementById('select-button');
        
        const folderId = folderSelect.value;
        if (!folderId) {
          fileSelect.innerHTML = '<option value="">フォルダを先に選択</option>';
          fileSelect.disabled = true;
          selectButton.disabled = true;
          return;
        }

        fileSelect.innerHTML = '<option value="">検索中...</option>';
        fileSelect.disabled = true;
        selectButton.disabled = true;
        loader.style.display = 'block';
        
        google.script.run.withSuccessHandler(function(files){
          populateFiles(files);
          loader.style.display = 'none';
          fileSelect.disabled = false;
        }).getPDFFilesInFolder(folderId);
      }
      
      function populateFiles(files) {
        const select = document.getElementById('file-select');
        select.innerHTML = '<option value="">選択してください</option>';
        if (files.length > 0) {
          files.forEach(function(file) {
            let option = new Option(file.name, file.id);
            select.appendChild(option);
          });
        } else {
          select.innerHTML = '<option value="">PDFファイルが見つかりません</option>';
        }
      }
      
      document.getElementById('file-select').addEventListener('change', function() {
        document.getElementById('select-button').disabled = !this.value;
      });

      function selectFile() {
        const fileId = document.getElementById('file-select').value;
        if (fileId) {
          document.getElementById('select-button').disabled = true;
          document.getElementById('select-button').innerText = '処理を開始しています...';
          google.script.run
            .withSuccessHandler(function() {
              google.script.host.close();
            })
            .setFileIdAndExtract(fileId);
        }
      }
    </script>
  </body>
</html>